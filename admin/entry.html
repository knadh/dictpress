<section x-data="entryComponent()"
    @open-entry-form.window="onOpen"
    @keyup.escape.window="onClose"
    @close-entry-form.window="onClose">
    <template x-if="isVisible">
        <aside class="panel">
            <div class="panel-header">
                <h2 x-text="isNew ? 'New entry' : 'Edit entry'"></h2>
                <button class="panel-close" @click.prevent="onClose">&times;</button>
            </div>

            <form @submit.prevent="onSave" class="panel-body">
                <div class="form-group">
                    <label>Content</label>
                    <template x-for="(item, idx) in entry.content" :key="idx">
                        <div class="input-with-action">
                            <textarea x-model="entry.content[idx]" required :autofocus="idx === 0" rows="2"></textarea>
                            <button type="button" class="remove-btn" @click.prevent="onDeleteContentItem(idx)" x-show="entry.content.length > 1">&times;</button>
                        </div>
                    </template>
                    <button type="button" class="add-btn" @click.prevent="onAddContentItem">+ Add variant</button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Language</label>
                        <select x-model="entry.lang" required>
                            <template x-for="[id, l] in Object.entries(config.languages)" :key="id">
                                <option :value="id" x-text="l.name" x-bind:selected="id === entry.lang"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 0 0 100px;">
                        <label>Initial</label>
                        <input type="text" x-model="entry.initial" @focus="onFocusInitial" required />
                    </div>
                </div>

                <details class="options-section">
                    <summary>Advanced options</summary>
                    <div class="options-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Status</label>
                                <select x-model="entry.status" required>
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                                <small class="help">Disabled entries are hidden from public view</small>
                            </div>
                            <div class="form-group">
                                <label>Weight</label>
                                <input type="number" step="0.01" x-model="entry.weight" placeholder="0 = auto" />
                                <small class="help">Smaller (negative) values rank higher in search results. 0 = automatic</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Phonetic notations</label>
                            <textarea x-model="entry.phones" rows="2" placeholder="One per line"></textarea>
                            <small class="help">IPA or other phonetic transcriptions for pronunciation</small>
                        </div>

                        <div class="form-group">
                            <label>Tags</label>
                            <textarea x-model="entry.tags" rows="2" placeholder="One per line"></textarea>
                            <small class="help">Custom strings to categorize entries (e.g., formal, archaic, source:somedict)</small>
                        </div>

                        <div class="form-group">
                            <label>Search tokens</label>
                            <textarea x-model="entry.tokens" rows="2" placeholder="One per line (blank = auto)"></textarea>
                            <small class="help">Fulltext (stemmed) search tokens for search indexing</small>
                        </div>

                        <div class="form-group">
                            <label>Notes</label>
                            <textarea x-model="entry.notes" rows="2"></textarea>
                            <small class="help">Optional notes describing the entry</small>
                        </div>

                        <div class="form-group">
                            <label>Meta (JSON)</label>
                            <textarea x-model="entry.meta_str" rows="2" class="mono"></textarea>
                            <small class="help">Custom metadata as a JSON object. Can be used in templating.</small>
                        </div>
                    </div>
                </details>

                <div class="panel-actions">
                    <button type="submit" class="btn-primary" x-bind:disabled="loading['entries.update'] === true || loading['entries.create'] === true">
                        Save
                    </button>
                    <button type="button" class="btn-secondary" @click.prevent="onClose">Cancel</button>
                    <button type="button" class="btn-danger" @click.prevent="onDeleteEntry" x-show="!isNew" x-bind:disabled="loading['entries.delete'] === true">
                        Delete
                    </button>
                </div>
            </form>

            <template x-if="!isNew">
                <div class="panel-meta">
                    <p><span>ID</span> <code x-text="entry.id"></code></p>
                    <p><span>GUID</span> <code x-text="entry.guid"></code></p>
                    <p><span>Created</span> <span x-text="entry.created_at.slice(0, 16).replace('T', ' ')"></span></p>
                    <p><span>Updated</span> <span x-text="entry.updated_at.slice(0, 16).replace('T', ' ')"></span></p>
                </div>
            </template>

            <template x-if="!isNew && parentEntries.length > 0">
                <div class="panel-section">
                    <h3>Parent entries (<span x-text="parentEntries.length"></span>)</h3>
                    <ul class="parent-list">
                        <template x-for="r in parentEntries" :key="r.id">
                            <li>
                                <a x-bind:href="makeURL({'id': r.id})">
                                    <template x-for="(item, idx) in r.content" :key="idx">
                                        <span><span x-text="item"></span><span x-show="idx < r.content.length - 1">, </span></span>
                                    </template>
                                </a>
                            </li>
                        </template>
                    </ul>
                </div>
            </template>
        </aside>
    </template>
</section>
